# Исправления чат-функциональности

## Проблемы, которые были решены

1. **POST /api/chat → 500 с ошибкой "assistant_unavailable"**
   - Причина: падение Assistants API ("run failed to start")
   - Решение: переход на Chat Completions API

2. **Изображения иногда 404**
   - Причина: неправильная обработка загрузки файлов
   - Решение: улучшена логика сохранения и проверки файлов

3. **Ответы ассистента одинаковые**
   - Причина: неправильная обработка истории сообщений
   - Решение: исправлена логика формирования контекста

4. **При переключении агента подтягивается не своя история**
   - Причина: история хранилась в localStorage без привязки к агенту
   - Решение: история теперь хранится в базе данных пер-агенту

## Внесенные изменения

### 1. База данных
- Добавлена таблица `chat_messages` для хранения истории чатов
- Индексы для быстрого поиска по пользователю и агенту

### 2. API изменения

#### `/api/chat/index.ts`
- Переход с Assistants API на Chat Completions API
- Добавлена валидация входных данных
- Правильная обработка ошибок с кодами 4xx/5xx
- Сохранение сообщений в базу данных
- Поддержка изображений через vision API

#### `/api/chat/history.ts` (новый)
- Получение истории чата для конкретного агента
- Фильтрация по пользователю и slug агента

#### `/api/chat/upload.ts`
- Улучшена обработка загрузки файлов
- Гарантированное создание каталога uploads
- Проверка сохранения файлов
- Уникальные имена файлов

### 3. Клиентские изменения

#### `pages/agents/[slug].tsx`
- Загрузка истории из базы данных вместо localStorage
- Обновленный API вызов с новыми параметрами
- Улучшенная обработка ошибок
- Правильное добавление сообщений в конец массива

## Новый формат API

### POST /api/chat
```json
{
  "text": "сообщение пользователя",
  "agentId": "asst_xxx",
  "attachments": ["url1", "url2"]
}
```

### GET /api/chat/history?agentSlug=xxx
```json
{
  "messages": [
    {
      "role": "user",
      "content": "текст",
      "attachments": [],
      "created_at": "2024-01-01T00:00:00Z"
    }
  ]
}
```

## Структура базы данных

```sql
CREATE TABLE chat_messages (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id TEXT NOT NULL,
  agent_slug TEXT NOT NULL,
  role TEXT NOT NULL CHECK (role IN ('user', 'assistant')),
  text TEXT NOT NULL,
  attachments TEXT, -- JSON array of URLs
  created_at TEXT DEFAULT (datetime('now'))
);
```

## Результат

✅ Чат стабильно отвечает без 500 ошибок
✅ Изображения корректно загружаются и отображаются
✅ История чата сохраняется пер-агенту
✅ Уникальные ответы ассистента
✅ Осмысленные ошибки с правильными кодами 